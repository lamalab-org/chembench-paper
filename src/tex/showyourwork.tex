% Imports
\RequirePackage{mathtools} % equation tags
\RequirePackage{xcolor} % custom colors
\RequirePackage{hyperref} % url links
\RequirePackage{suffix} % allows definition of starred commmands
\RequirePackage{fontawesome5} % FontAwesome symbols
\RequirePackage{letltxmacro} % command redefinitions
\RequirePackage{xstring} % string manipulation
\RequirePackage{catchfile} % read file into macro
\RequirePackage{totcount} % count total number of errors
\RequirePackage[notref, notcite]{showkeys} % get label refs
\RequirePackage{xspace} % better spacing after icons
\RequirePackage{graphicx} % includegraphics
\RequirePackage{etoolbox} % ifcsmacro

% Logging
\newwrite\syw@LogFile
\immediate\openout\syw@LogFile=showyourwork.xml
\newcommand\syw@LogMessage[1]{%
  \protected@write
  \syw@LogFile
  {\let\tmp\write\def\write{\immediate\tmp}}%
  {#1}%
}

% Log something to ensure the XML file gets created
\syw@LogMessage{<!--XML article tree automatically generated by showyourwork-->}

% Log custom figure links
\newcommand\marginicon[1]{%
  \syw@LogMessage{<MARGINICON />}%
}

% Log figure script commands
\newcommand\script[1]{%
  \syw@LogMessage{<SCRIPT>#1</SCRIPT>}%
}

% Log labels
\renewcommand\showkeyslabelformat[1]{%
  \syw@LogMessage{<LABEL>#1</LABEL>}%
}

% Log figures
\ifcsmacro{figure}{
  \let\oldfigure\figure
  \let\oldendfigure\endfigure
  \renewenvironment{figure}{%
    \syw@LogMessage{<FIGURE>}%
    \oldfigure%
  }{%
    \oldendfigure%
    \syw@LogMessage{</FIGURE>}%
  }
  \renewenvironment{figure*}{%
    \syw@LogMessage{<FIGURE>}%
    \oldfigure%
  }{%
    \oldendfigure%
    \syw@LogMessage{</FIGURE>}%
  }
}{}

% Log equations
\ifcsmacro{align}{
  \let\oldalign\align
  \let\oldendalign\endalign
  \renewenvironment{align}{%
    \syw@LogMessage{<ALIGN>}%
    \oldalign%
  }{%
    \oldendalign%
    \syw@LogMessage{</ALIGN>}%
  }
  \renewenvironment{align*}{%
    \syw@LogMessage{<ALIGN>}%
    \oldalign%
  }{%
    \oldendalign%
    \syw@LogMessage{</ALIGN>}%
  }
}{}

% Log figure captions
\ifcsmacro{caption}{
  \renewcommand{\caption}{%
    \syw@LogMessage{<CAPTION />}%
  }
}

% Log graphics
\renewcommand{\includegraphics}[2][]{%
  \syw@LogMessage{<GRAPHICS>#2</GRAPHICS>}%
}

% Log graphicspath
\renewcommand{\graphicspath}[1]{%
  \syw@LogMessage{<GRAPHICSPATH>#1</GRAPHICSPATH>}%
}

% Disable bibliography
\renewcommand{\bibliography}[1]{}

% Disable user-facing commands
\newcommand\GitHubURL{}
\newcommand\GitHubSHA{}
\newcommand\GitHubIcon{}
\newcommand\showyourwork{}

% Alias of \input for syw-controlled files;
% but make it a no-op at the pre-processing
% stage that simply prints the argument to the log
% so we can add the file to the workflow graph
\newcommand\variable[1]{%
  \syw@LogMessage{<INPUT>#1</INPUT>}%
}
